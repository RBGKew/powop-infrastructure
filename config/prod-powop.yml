---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: solr-data-prod
  labels:
    name: solr-data-prod
spec:
  capacity:
    storage: 20Gi
  accessModes:
    - ReadWriteOnce
  gcePersistentDisk:
    pdName: solr-data-prod
    fsType: ext4
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: solr-data-claim
spec:
  resources:
    requests:
      storage: 10Gi
  accessModes:
    - ReadWriteOnce
  selector:
    matchLabels:
      name: solr-data-prod
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: portal
spec:
  replicas: 2
  template:
    metadata:
      labels:
        name: portal
    spec:
      containers:
        - name: portal
          image: eu.gcr.io/powop-1349/portal:1.1.3-SNAPSHOT-d5e0c35
          readinessProbe:
            httpGet:
              path: /ping
              port: 8080
            initialDelaySeconds: 20
            timeoutSeconds: 1
          env:
            - name: JDBC_DRIVER_URL
              value: jdbc:mysql://127.0.0.1:3306/emonocot
            - name: JDBC_DRIVER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-secrets
                  key: jdbc-driver-password
          ports:
            - containerPort: 8009
          volumeMounts:
            - name: cloudsql-oauth-credentials
              mountPath: /secrets/cloudsql
              readOnly: true
        - name: cloudsql-proxy
          image: b.gcr.io/cloudsql-docker/gce-proxy:1.05
          command: ["/cloud_sql_proxy", "--dir=/cloudsql",
                    "-instances=powop-1349:europe-west1:powop-prod-db=tcp:3306",
                    "-credential_file=/secrets/cloudsql/cloudsql-credentials.json"]
          volumeMounts:
            - name: cloudsql-oauth-credentials
              mountPath: /secrets/cloudsql
              readOnly: true
            - name: ssl-certs
              mountPath: /etc/ssl/certs
      volumes:
        - name: cloudsql-oauth-credentials
          secret:
            secretName: cloudsql-oauth-credentials
        - name: ssl-certs
          hostPath:
            path: /etc/ssl/certs
---
apiVersion: v1
kind: Service
metadata:
  name: portal
spec:
  selector:
    name: portal
  ports:
    - port: 8009
---
# Harvester
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: harvester
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: harvester
    spec:
      containers:
        - name: harvester
          image: eu.gcr.io/powop-1349/harvester:1.1.3-SNAPSHOT-d5e0c35
          env:
            - name: JDBC_DRIVER_URL
              value: jdbc:mysql://127.0.0.1:3306/emonocot
            - name: JDBC_DRIVER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-secrets
                  key: jdbc-driver-password
          ports:
            - containerPort: 8009
        - name: cloudsql-proxy
          image: b.gcr.io/cloudsql-docker/gce-proxy:1.05
          command: ["/cloud_sql_proxy", "--dir=/cloudsql",
                    "-instances=powop-1349:europe-west1:powop-prod-db=tcp:3306",
                    "-credential_file=/secrets/cloudsql/cloudsql-credentials.json"]
          volumeMounts:
            - name: cloudsql-oauth-credentials
              mountPath: /secrets/cloudsql
              readOnly: true
            - name: ssl-certs
              mountPath: /etc/ssl/certs
      volumes:
        - name: cloudsql-oauth-credentials
          secret:
            secretName: cloudsql-oauth-credentials
        - name: ssl-certs
          hostPath:
            path: /etc/ssl/certs
---
apiVersion: v1
kind: Service
metadata:
  name: harvester
spec:
  selector:
    name: harvester
  ports:
    - port: 8009
---
# Geoserver database
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: geodb
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: geodb
    spec:
      containers:
        - name: geodb
          image: eu.gcr.io/powop-1349/geodb:1.1.3-SNAPSHOT
          ports:
            - containerPort: 3306
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: geo-db-secrets
                  key: mysql-root-password
            - name: MYSQL_DATABASE
              valueFrom:
                secretKeyRef:
                  name: geo-db-secrets
                  key: mysql-database
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: geo-db-secrets
                  key: mysql-user
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: geo-db-secrets
                  key: mysql-password
---
apiVersion: v1
kind: Service
metadata:
  name: geodb
spec:
  selector:
    name: geodb
  ports:
    - port: 3306
# Geoserver
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: geoserver
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: geoserver
    spec:
      containers:
        - name: activemq
          image: eu.gcr.io/powop-1349/geoserver:1.1.3-SNAPSHOT
          ports:
            - containerPort: 8009
---
apiVersion: v1
kind: Service
metadata:
  name: geoserver
spec:
  selector:
    name: geoserver
  ports:
    - port: 8009
# Apache
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: apache
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: apache
    spec:
      containers:
        - name: apache
          image: eu.gcr.io/powop-1349/apache:1.1.3-SNAPSHOT-d5e0c35
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: apache
spec:
  selector:
    name: apache
  ports:
    - port: 80
  type: LoadBalancer
# Solr
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: solr
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: solr
    spec:
      containers:
        - name: solr
          imagePullPolicy: Always
          image: eu.gcr.io/powop-1349/solr:1.1.3-SNAPSHOT-d5e0c35
          ports:
            - containerPort: 8983
          volumeMounts:
            - name: solr-data
              mountPath: /opt/solr/server/solr/powop/data
      volumes:
        - name: solr-data
          persistentVolumeClaim:
            claimName: solr-data-claim
---
apiVersion: v1
kind: Service
metadata:
  name: solr
spec:
  selector:
    name: solr
  ports:
    - port: 8983
# ActiveMQ
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: activemq
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: activemq
    spec:
      containers:
        - name: activemq
          image: rmohr/activemq:5.12.0
          ports:
            - containerPort: 61616
---
apiVersion: v1
kind: Service
metadata:
  name: activemq
spec:
  selector:
    name: activemq
  ports:
    - port: 61616
