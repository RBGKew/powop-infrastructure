# Production Operations Manual

Production POWO is deployed via a Kubernetes cron job which re-builds the full system on a schedule. This extra layer of indirection can be somewhat confusing, so this guide aims to demystify the deployment process.

There are three repositories related to POWO:

* powop: [private](git@kppgitlab01.ad.kew.org:development/powop.git), [github](https://github.com/RBGKew/powop)
* powop-infrastructure: [private](git@kppgitlab01.ad.kew.org:development/powop-infrastructure.git), [github](git@github.com:RBGKew/powop-infrastructure.git)
* powo-secrets: [private](git@kppgitlab01.ad.kew.org:secrets/powop-secrets.git)

The components that make up the deployment system are:

* The builder which handles the orchistration of deploying, loading data, and swapping DNS, which lives in the main POWO code repo in ``powop/powo-builder``
* The kubernetes configuration for the builder job which lives in ``powop-infrastructure/powo-builder``
* The kubernetes configuration for deploying POWO which lives in ``powop-infrastructure/powo``
* Deployment credentials and production secrets which live in the private ``powop-secrets`` repo, included in this repo as a submodule ``powop-infrastructure/secrets`` which you can sync if you have access to

## Code Updates

There are two ways of deploying code updates: direct updates and builder updates that will be picked up on the next re-build.

Direct updates should only be done if you need to deploy an urgent fix, or if you have a code change you want to verify in production before letting it run on the scheduled rebuild. Always remember that any direct update you do to the running prod build will be wiped out next time the scheduled rebuild happens unless you also update the builder.

Builder updates will only come into effect the next time a scheduled rebuild happens.

### Both Direct and Builder

1) Update the relevant ``version`` keys in the [values file](./powo/values.yaml) with the latest git short hash which you can get by running in ``powop``

        git rev-parse --short HEAD

    You usually only need to change ``harvester.version``, or ``portal.version`` and ``apache.version`` (portal and apache must be changed together)

2) Make sure updated images are pushed to the google repository. From ``powop`` run

        mvn deploy

### Direct Update

3) Determine name of release you want to update:

        $ helm list
        NAME        VERSION   UPDATED               STATUS     CHART        NAMESPACE  
        prod-j8x91  1         Sat Dec 8 05:00 2018  DEPLOYED   powo-0.1.0   prod-j8x91  

    The builder creates a new release with an autogenerated name (e.g., prod-j8x91) each time it runs so you have to find the current release name.

4) Deploy new pods via helm (assuming a release called prod-j8x91)

        helm upgrade -f secrets/prod/secrets.yaml -f powo/prod.yaml prod-j8x91 powo/

5) Verify new pods load successfully

        kubectl get pod --namespace=prod-j8x91

### Builder Update

3) Push ``powop-infrastructure`` repo to github

        git push github master

## Data Updates

## Cluster Updates

## Troubleshooting